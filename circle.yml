#
# Build configuration for Circle CI
#

general:
    artifacts:
        - /home/ubuntu/popular-movies-app/app/build/outputs/apk/

machine:
    environment:
        PATH: "~/$CIRCLE_PROJECT_REPONAME/gradle-2.9/bin:$PATH"
        TERM: "dumb"
        ADB_INSTALL_TIMEOUT: "10"
        GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
        ANDROID_HOME: /usr/local/android-sdk-linux

dependencies:
  cache_directories:
    - /home/ubuntu/.android
  override:
        - wget "https://services.gradle.org/distributions/gradle-2.9-bin.zip"; unzip gradle-2.9-bin.zip
        - echo y | android update sdk --no-ui --all --filter "tools,platform-tools,android-23"
        - echo y | android update sdk --no-ui --all --filter "build-tools-23.0.2"

        

test:
  override:
   # start the emulator
   - emulator -avd circleci-android22 -no-audio -no-window:
       background: true
       parallel: true
   # execute the local junit tests as we wait for the emulator to boot
   # we are explicitely specifying the gradle targets here, because with the command
   # ./gradlew test, the tests would be executed for all 3 variants, and prodRelease
   # is not needed at that point.
   - (./gradlew testMockDebugUnitTest testProdDebugUnitTest)

   # block until the emulator has booted
   - circle-android wait-for-boot

   # unlock screen
   # https://discuss.circleci.com/t/android-test-fails-with-a-failure-to-get-the-focus-of-root-view/139
   - sleep 30
   - adb shell input keyevent 82

   # execute the android tests (instrumentation)
   - (./gradlew connectedAndroidTest -PdisablePreDex):
      timeout: 6000

   # copy the build outputs to artifacts
   - cp -r app/build/outputs $CIRCLE_ARTIFACTS

   # copy the test results to the test results directory.

   # instrumentation
   - cp -r app/build/outputs/androidTest-results/* $CIRCLE_TEST_REPORTS
   - cp -r app/build/reports/coverage $CIRCLE_TEST_REPORTS

   # local junit
   - cp -r app/build/test-results/mockDebug app/build/test-results/prodDebug $CIRCLE_TEST_REPORTS